# 手动迁移分区

当自动的负载均衡无法满足用户对于特定分区的聚合和打散需求时，可以通过手动方式迁移分区。

## 使用限制及注意事项

* 仅支持在主租户上执行手动迁移分区操作。

* 关闭租户的 Transfer 功能（即租户下配置项 `enable_transfer` 的值为 `false`）后，对该租户执行 `TRANSFER PARTITION` 语句会报错，同时已经在执行的分区迁移任务可能会被取消。

* 不支持手动迁移系统表的分区。

* 不支持将普通日志流迁移到广播日志流上，同时也不支持将广播日志流迁移到普通日志流上。

* 不支持迁移非独立的分区，例如，不支持迁移局部索引表的分区和 LOB 表的分区。

* 对于同一个分区，在分区迁移操作未完成之前，不允许再次发起分区迁移操作。

* 如果当前集群中已经有一个均衡任务（BALANCE_JOB）正在处理，手动触发的分区迁移不会立刻开始调度。

* 分区迁移本身不受配置项 `enable_rebalance` 的控制，但当 `enable_rebalance` 与 `enable_transfer` 的值均为 `true` 时，可能会出现以下情况，即用户将某个分区迁移到对应的日志流上后，系统的自动均衡功能又将该分区迁移到其他日志流上了。

## 前提条件

手动迁移分区前，需要开启 Transfer 功能。Transfer 功能由租户级配置项 `enable_transfer` 控制，默认值为 `true`，表示开启 Transfer 功能。有关配置项 `enable_transfer` 的详细说明及设置，请参见 [enable_transfer](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/400.tenant-level-configuration-items/25600.enable_transfer.md)。

## 系统租户手动迁移分区

1. 使用 `root` 用户登录到集群的 `sys` 租户。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   obclient -h10.xx.xx.xx -P2883 -uroot@sys#obdemo -p***** -A
   ```

2. 查询视图 `DBA_OB_TENANTS`，获取待进行分区迁移的租户的 `TENANT_ID`。

   ```sql
   obclient [oceanbase]> SELECT TENANT_ID FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = 'oracle_tenant';
   ```

   查询结果如下：

   ```shell
   +-----------+
   | TENANT_ID |
   +-----------+
   |      1004 |
   +-----------+
   1 row in set
   ```

3. 查询视图 `CDB_OB_TABLE_LOCATIONS`，获取指定分区的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`。

   * 获取非分区表的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`

      ```sql
      obclient [oceanbase]> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID FROM oceanbase.CDB_OB_TABLE_LOCATIONS WHERE TENANT_ID = 1004 AND DATABASE_NAME = 'SYS' AND TABLE_NAME= 'T1' LIMIT 1;
      ```

      查询结果如下：

      ```shell
      +----------+-----------+-----------+-------+
      | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID |
      +----------+-----------+-----------+-------+
      |   500460 |    500460 |    200258 |  1001 |
      +----------+-----------+-----------+-------+
      1 row in set
      ```


   * 获取一级分区表的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`

      对于一级分区表，查询时只需要指定具体的一级分区名即可。示例如下：


      ```sql
      obclient [oceanbase]> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID FROM oceanbase.CDB_OB_TABLE_LOCATIONS WHERE TENANT_ID = 1004 AND DATABASE_NAME = 'SYS' AND TABLE_NAME= 'TBL1_LOG_R' AND PARTITION_NAME = 'M202005' LIMIT 1;
      ```

      查询结果如下：

      ```shell
      +----------+-----------+-----------+-------+
      | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID |
      +----------+-----------+-----------+-------+
      |   500461 |    500467 |    200263 |  1001 |
      +----------+-----------+-----------+-------+
      1 row in set
      ```

   * 获取二级分区表的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`

      对于二级分区表，查询时需要同时指定一级分区名和二级分区名。示例如下：

      ```sql
      obclient [oceanbase]> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID FROM oceanbase.CDB_OB_TABLE_LOCATIONS WHERE TENANT_ID = 1004 AND DATABASE_NAME = 'SYS' AND TABLE_NAME= 'T2_F_RL' AND PARTITION_NAME = 'P1' AND SUBPARTITION_NAME = 'SP2' LIMIT 1;
      ```

      查询结果如下：

      ```shell
      +----------+-----------+-----------+-------+
      | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID |
      +----------+-----------+-----------+-------+
      |   500476 |    500481 |    200274 |  1001 |
      +----------+-----------+-----------+-------+
      1 row in set
      ```

4. 获取租户的日志流信息。

   1. 查询视图 `CDB_OB_LS`，获取租户的日志流状态和信息。

      ```sql
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_LS WHERE TENANT_ID = 1004;
      ```

      查询结果如下：

      ```shell
      +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
      | TENANT_ID | LS_ID | STATUS | PRIMARY_ZONE | UNIT_GROUP_ID | LS_GROUP_ID | CREATE_SCN          | DROP_SCN | SYNC_SCN            | READABLE_SCN        | FLAG |
      +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
      |      1004 |     1 | NORMAL | z1;z2,z3     |             0 |           0 |                NULL |     NULL | 1698812940911746268 | 1698812940911746268 |      |
      |      1004 |  1001 | NORMAL | z1;z2,z3     |          1001 |        1001 | 1698721177181204494 |     NULL | 1698812940911746268 | 1698812940911746268 |      |
      |      1004 |  1003 | NORMAL | z2;z1,z3     |          1001 |        1001 | 1698812926195529442 |     NULL | 1698812940590579482 | 1698812940590579482 |      |
      |      1004 |  1004 | NORMAL | z3;z1,z2     |          1001 |        1001 | 1698812937427788796 |     NULL |                   1 |                   1 |      |
      +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
      4 rows in set
      ```  

   2. 查询视图 `CDB_OB_TABLET_TO_LS`，获取日志流上 Tablet 的分布信息。

      ```sql
      obclient [oceanbase]> SELECT LS_ID, COUNT(*) AS C FROM oceanbase.CDB_OB_TABLET_TO_LS WHERE TENANT_ID = 1004 GROUP BY LS_ID;
      ```

      查询结果如下：

      ```shell
      +-------+------+
      | LS_ID | C    |
      +-------+------+
      |     1 |  571 |
      |  1001 |   25 |
      |  1004 |   12 |
      |  1003 |   24 |
      +-------+------+
      4 rows in set
      ```

      根据上述展示的信息，选择合适的日志流作为迁移目的端。

5. 执行以下命令，进行分区迁移。

   ```sql
   ALTER SYSTEM TRANSFER PARTITION TABLE_ID [=] table_id, OBJECT_ID [=] object_id TO LS ls_id TENANT = 'tenant_name';
   ```

   其中：

   * `table_id`：表 ID。

   * `OBJECT_ID`：分区的唯一标识。

   * `ls_id`：分区迁移的目的端的日志流 ID。

   * `tenant_name`：待迁移的表所属的租户。

   以租户 `oracle_tenant` 为例，将其 `SYS` 库下的表 `TBL1_LOG_R` 的 `M202005` 分区，从当前 `1001` 号日志流迁移到 `1004` 号日志流上，示例如下。

   ```sql
   obclient [oceanbase]> ALTER SYSTEM TRANSFER PARTITION TABLE_ID = 500461, OBJECT_ID = 500467 TO LS 1004 tenant = 'oracle_tenant';
   ```

6. 分区迁移过程中，可以通过以下视图查看分区迁移情况。

   1. 查询视图 `CDB_OB_TRANSFER_PARTITION_TASKS`，获取任务的 `TASK_ID`、`TRANSFER_TASK_ID` 和 `BALANCE_JOB_ID`。

      ```sql
      obclient [oceanbase]> SELECT TASK_ID, BALANCE_JOB_ID, TRANSFER_TASK_ID FROM oceanbase.CDB_OB_TRANSFER_PARTITION_TASKS WHERE TENANT_ID = 1004 AND TABLE_ID = 500461 AND OBJECT_ID = 500467;
      ```

   2. 查询视图 `CDB_OB_BALANCE_JOBS` 或 `CDB_OB_BALANCE_JOB_HISTORY`，确认关联的 BALANCE_JOB 的执行状态。

      ```sql
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_BALANCE_JOBS WHERE JOB_ID = $BALANCE_JOB_ID;
      ```

      ```sql
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_BALANCE_JOB_HISTORY WHERE JOB_ID = $BALANCE_JOB_ID;
      ```

      其中，`$BALANCE_JOB_ID` 需要替换为上一步获取的 `BALANCE_JOB_ID`。

   3. 查询视图 `CDB_OB_TRANSFER_TASKS` 或 `CDB_OB_TRANSFER_TASK_HISTORY`，确认任务关联的 TRANSFER_TASK 的执行状态。

      ```sql
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_TRANSFER_TASKS WHERE TASK_ID = $TRANSFER_TASK_ID;
      ```

      ```sql
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_TRANSFER_TASK_HISTORY WHERE TASK_ID = $TRANSFER_TASK_ID;
      ```

      其中，`$TRANSFER_TASK_ID` 需要替换为前面步骤中获取的 `TRANSFER_TASK_ID`。

  4. 查询视图 `CDB_OB_TRANSFER_PARTITION_TASK_HISTORY`，确认分区迁移任务的结果。

      ```sql
      obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_TRANSFER_PARTITION_TASK_HISTORY WHERE TASK_ID = $TASK_ID;
      ```

      其中，`$TASK_ID` 需要替换为前面步骤中获取的 `TASK_ID`。

## 用户租户手动迁移分区

本文档以租户 `oracle_tenant` 为例，提供操作指导。

1. 用户租户的租户管理员连接数据库。

   连接示例如下，连接数据库时请以实际环境为准。

   ```shell
   obclient -h10.xx.xx.xx -P2883 -uroot@oracle_tenant#obdemo -p***** -A
   ```

2. 查询视图 `DBA_OB_TABLE_LOCATIONS`，获取指定分区的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`。

   * 获取非分区表的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`

      ```sql
      obclient [SYS]> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID FROM SYS.DBA_OB_TABLE_LOCATIONS WHERE DATABASE_NAME = 'SYS' AND TABLE_NAME= 'T1';
      ```

      查询结果如下：

      ```shell
      +----------+-----------+-----------+-------+
      | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID |
      +----------+-----------+-----------+-------+
      |   500460 |    500460 |    200258 |  1001 |
      +----------+-----------+-----------+-------+
      1 row in set
      ```


   * 获取一级分区表的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`

      对于一级分区表，查询时只需要指定具体的一级分区名即可。示例如下：


      ```sql
      obclient [SYS]> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID FROM SYS.DBA_OB_TABLE_LOCATIONS WHERE DATABASE_NAME = 'SYS' AND TABLE_NAME= 'TBL1_LOG_R' AND PARTITION_NAME = 'M202005';
      ```

      查询结果如下：

      ```shell
      +----------+-----------+-----------+-------+
      | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID |
      +----------+-----------+-----------+-------+
      |   500461 |    500467 |    200263 |  1001 |
      +----------+-----------+-----------+-------+
      1 row in set
      ```

   * 获取二级分区表的 `TABLET_ID`、`OBJECT_ID` 以及 `LS_ID`

      对于二级分区表，查询时需要同时指定一级分区名和二级分区名。示例如下：

      ```sql
      obclient [SYS]> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID FROM SYS.DBA_OB_TABLE_LOCATIONS WHERE DATABASE_NAME = 'SYS' AND TABLE_NAME= 'T2_F_RL' AND PARTITION_NAME = 'P1' AND SUBPARTITION_NAME = 'SP2';
      ```

      查询结果如下：

      ```shell
      +----------+-----------+-----------+-------+
      | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID |
      +----------+-----------+-----------+-------+
      |   500476 |    500481 |    200274 |  1001 |
      +----------+-----------+-----------+-------+
      1 row in set
      ```

4. 获取租户的日志流信息。

   1. 查询视图 `DBA_OB_LS`，获取租户的日志流状态和信息。

      ```sql
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_LS;
      ```

      查询结果如下：

      ```shell
      +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
      | TENANT_ID | LS_ID | STATUS | PRIMARY_ZONE | UNIT_GROUP_ID | LS_GROUP_ID | CREATE_SCN          | DROP_SCN | SYNC_SCN            | READABLE_SCN        | FLAG |
      +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
      |      1004 |     1 | NORMAL | z1;z2,z3     |             0 |           0 |                NULL |     NULL | 1698812940911746268 | 1698812940911746268 |      |
      |      1004 |  1001 | NORMAL | z1;z2,z3     |          1001 |        1001 | 1698721177181204494 |     NULL | 1698812940911746268 | 1698812940911746268 |      |
      |      1004 |  1003 | NORMAL | z2;z1,z3     |          1001 |        1001 | 1698812926195529442 |     NULL | 1698812940590579482 | 1698812940590579482 |      |
      |      1004 |  1004 | NORMAL | z3;z1,z2     |          1001 |        1001 | 1698812937427788796 |     NULL |                   1 |                   1 |      |
      +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
      4 rows in set
      ```  

   2. 查询视图 `DBA_OB_TABLET_TO_LS`，获取日志流上 Tablet 的分布信息。

      ```sql
      obclient [SYS]> SELECT LS_ID, COUNT(*) AS C FROM SYS.DBA_OB_TABLET_TO_LS GROUP BY LS_ID;
      ```

      查询结果如下：

      ```shell
      +-------+------+
      | LS_ID | C    |
      +-------+------+
      |     1 |  571 |
      |  1001 |   25 |
      |  1004 |   12 |
      |  1003 |   24 |
      +-------+------+
      4 rows in set
      ```

      根据上述展示的信息，选择合适的日志流作为迁移目的端。

5. 执行以下命令，进行分区迁移。

   ```sql
   ALTER SYSTEM TRANSFER PARTITION TABLE_ID [=] table_id, OBJECT_ID [=] object_id TO LS ls_id;
   ```

   其中：

   * `table_id`：表 ID。

   * `OBJECT_ID`：分区的唯一标识。

   * `ls_id`：分区迁移的目的端的日志流 ID。

   * `tenant_name`：待迁移的表所属的租户。

   以租户 `oracle_tenant` 为例，将其 `SYS` 库下的表 `TBL1_LOG_R` 的 `M202005` 分区，从当前 `1001` 号日志流迁移到 `1004` 号日志流上，示例如下。

   ```sql
   obclient [SYS]> ALTER SYSTEM TRANSFER PARTITION TABLE_ID = 500461, OBJECT_ID = 500467 TO LS 1004;
   ```

6. 分区迁移过程中，可以通过以下视图查看分区迁移情况。

   1. 查询视图 `DBA_OB_TRANSFER_PARTITION_TASKS`，获取任务的 `TASK_ID`、`TRANSFER_TASK_ID` 和 `BALANCE_JOB_ID`。

      ```sql
      obclient [SYS]> SELECT TASK_ID, BALANCE_JOB_ID, TRANSFER_TASK_ID FROM SYS.DBA_OB_TRANSFER_PARTITION_TASKS WHERE TABLE_ID = 500461 AND OBJECT_ID = 500467;
      ```

   2. 查询视图 `DBA_OB_BALANCE_JOBS` 或 `DBA_OB_BALANCE_JOB_HISTORY`，确认关联的 BALANCE_JOB 的执行状态。

      ```sql
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_BALANCE_JOBS WHERE JOB_ID = $BALANCE_JOB_ID;
      ```

      ```sql
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_BALANCE_JOB_HISTORY WHERE JOB_ID = $BALANCE_JOB_ID;
      ```

      其中，`$BALANCE_JOB_ID` 需要替换为上一步获取的 `BALANCE_JOB_ID`。

   3. 查询视图 `DBA_OB_TRANSFER_TASKS` 或 `DBA_OB_TRANSFER_TASK_HISTORY`，确认任务关联的 TRANSFER_TASK 的执行状态。

      ```sql
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_TRANSFER_TASKS WHERE TASK_ID = $TRANSFER_TASK_ID;
      ```

      ```sql
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_TRANSFER_TASK_HISTORY WHERE TASK_ID = $TRANSFER_TASK_ID;
      ```

      其中，`$TRANSFER_TASK_ID` 需要替换为前面步骤中获取的 `TRANSFER_TASK_ID`。

  4. 查询视图 `DBA_OB_TRANSFER_PARTITION_TASK_HISTORY`，确认分区迁移任务的结果。

      ```sql
      obclient [SYS]> SELECT * FROM SYS.DBA_OB_TRANSFER_PARTITION_TASK_HISTORY WHERE TASK_ID = $TASK_ID;
      ```

      其中，`$TASK_ID` 需要替换为前面步骤中获取的 `TASK_ID`。
