|description||
|---|---|
|keywords||
|dir-name||
|dir-name-en||
|tenant-type||

# 附：备切主验证失败的错误信息及处理方法

在执行 `SWITCHOVER TO PRIMARY VERIFY` 命令和 `ACTIVATE STANDBY VERIFY` 命令验证备租户是否可以切换为主租户，或者执行 `SWITCHOVER TO PRIMARY` 命令和 `ACTIVATE STANDBY` 命令进行备切主操作时，系统可能会提示报错信息，该报错信息展示了不能成功执行切换命令的原因，本节主要列举可能出现的报错信息所表示的含义以及针对该报错的处理方法。

## 报错信息 1：

* `log restore source is primary, switchover to primary is not allowed`

* `log restore source is not normal switchover status, switchover to primary is not allowed`

* `log restore source is not normal status, switchover to primary is not allowed`

### 含义

仅在执行 `SWITCHOVER TO PRIMARY VERIFY` 命令时，会出现该报错。

对于基于网络的物理备库，需要恢复源所在的租户满足以下所有条件，否则无法成功执行 `SWITCHOVER TO PRIMARY VERIFY` 命令：

1. 租户角色 `TENANT_ROLE` 为 `PRIMARY`

2. 租户状态 `STATUS` 为 `NORMAL` 

3. 租户的 `SWITCHOVER_STATUS` 为 `NORMAL`

### 处理方法

1. 登录恢复源所在的集群，查询该租户的状态。

    :::tab
    tab 系统租户

    系统租户下，通过以下 SQL 查看恢复源所在租户的状态。

    ```sql
    SELECT TENANT_NAME, TENANT_ID, TENANT_ROLE, STATUS, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = 'tenant_name';
    ```

    其中，`tenant_name` 需要替换为恢复源所在租户的租户名。

    tab 用户租户

    MySQL 模式租户下，通过以下 SQL 查看当前租户（恢复源所在的租户）的状态。

    ```sql
    SELECT TENANT_NAME, TENANT_ID, TENANT_ROLE, STATUS, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS;
    ```

    Oracle 模式租户下，通过以下 SQL 查看当前租户（恢复源所在的租户）的状态。

    ```sql
    SELECT TENANT_NAME, TENANT_ID, TENANT_ROLE, STATUS, SWITCHOVER_STATUS FROM SYS.DBA_OB_TENANTS;
    ```

    :::

2. 根据查询结果，排查恢复源不满足上述条件的原因，并联系技术支持人员协助处理。

    :::tab
    tab 系统租户

    系统租户下，可以通过以下 SQL 语句，检查恢复源所在租户主备切换的操作历史。

    ```sql
    SELECT * FROM oceanbase.DBA_OB_TENANT_EVENT_HISTORY WHERE TENANT_ID = user_tenant_id AND MODULE = 'TENANT ROLE CHANGE';
    ```

    其中，`user_tenant_id` 需要替换为恢复源所在租户的 `TENANT_ID`。

    tab 用户租户

    MySQL 模式租户下，通过以下 SQL 查看当前租户（恢复源所在的租户）的主备切换操作历史。

    ```sql
    SELECT * FROM oceanbase.DBA_OB_TENANT_EVENT_HISTORY;
    ```

    Oracle 模式租户下，通过以下 SQL 查看当前租户（恢复源所在的租户）的主备切换操作历史。

    ```sql
    SELECT * FROM SYS.DBA_OB_TENANT_EVENT_HISTORY;
    ```

    :::

## 报错信息 2：

* `tenant status is not normal, switchover to primary is not allowed`

* `tenant status is not normal, failover to primary is not allowed`

### 含义

当前租户的状态不是 `NORMAL`，只有 `NORMAL` 状态的租户才能执行角色切换命令。

### 处理方法

1. 执行以下 SQL，查询当前租户的状态。

    :::tab
    tab 系统租户

    系统租户下，通过以下 SQL 查看指定租户的状态。

    ```sql
    SELECT TENANT_NAME, STATUS FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = 'tenant_name';
    ```

    其中，`tenant_name` 需要替换为待执行角色切换命令的租户的租户名。

    tab 用户租户

    MySQL 模式下，通过以下 SQL 查看当前租户的状态。

    ```sql
    SELECT TENANT_NAME, STATUS FROM oceanbase.DBA_OB_TENANTS;
    ```

    Oracle 模式下，通过以下 SQL 查看当前租户的状态。

    ```sql
    SELECT TENANT_NAME, STATUS FROM SYS.DBA_OB_TENANTS;
    ```

    :::

2. 根据查询结果，排查租户状态不是 `NORMAL` 的原因，租户可能还在创建中或恢复中，可以等待租户创建完成，或联系技术支持人员协助处理。

## 报错信息 3：

* `switchover status not match, switchover to primary is not allowed`

* `switchover status not match, failover to primary is not allowed`

### 含义

租户处于当前的 `SWITCHOVER_STATUS` 状态时，不能执行指定的切换命令。

### 处理方法[](正常 `SWITCHOVER_STATUS` 应该是什么状态才可以？这里是什么状态？)

1. 执行以下 SQL，查询当前租户 `SWITCHOVER_STATUS` 的状态。

    :::tab
    tab 系统租户

    系统租户下，通过以下 SQL 查看指定租户的 `SWITCHOVER_STATUS` 的状态。

    ```sql
    SELECT TENANT_NAME, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = 'tenant_name';
    ```

    其中，`tenant_name` 需要替换为待执行角色切换命令的租户的租户名。

    tab 用户租户

    MySQL 模式下，通过以下 SQL 查看当前租户 `SWITCHOVER_STATUS` 的状态。

    ```sql
    SELECT TENANT_NAME, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS;
    ```

    Oracle 模式下，通过以下 SQL 查看当前租户 `SWITCHOVER_STATUS` 的状态。

    ```sql
    SELECT TENANT_NAME, SWITCHOVER_STATUS FROM SYS.DBA_OB_TENANTS;
    ```

    :::

2. 根据查询结果，排查租户的 `SWITCHOVER_STATUS` 处于此状态的原因，并联系技术支持人员协助处理。

## 报错信息 4：

`Incorrect arguments to tenant name, only support operating user tenant`

### 含义

租户类型不是 `USER`，只能对用户租户执行角色切换命令。

### 处理方法

1. 执行以下 SQL，查询当前租户的租户类型。

    :::tab
    tab 系统租户

    系统租户下，通过以下 SQL 查看指定租户的租户类型。

    ```sql
    SELECT TENANT_NAME, TENANT_TYPE FROM oceanbase.DBA_OB_TENANTS WHERE TENANT_NAME = 'tenant_name';
    ```

    其中，`tenant_name` 需要替换为待执行角色切换命令的租户的租户名。

    tab 用户租户

    MySQL 模式下，通过以下 SQL 查看当前租户的租户类型。

    ```sql
    SELECT TENANT_NAME, TENANT_TYPE FROM oceanbase.DBA_OB_TENANTS;
    ```

    Oracle 模式下，通过以下 SQL 查看当前租户的租户类型。

    ```sql
    SELECT TENANT_NAME, TENANT_TYPE FROM SYS.DBA_OB_TENANTS;
    ```

    :::

2. 根据查询结果，检查命令中指定的租户名是否正确，并重新执行角色切换命令。

## 报错信息 5：

`Incorrect arguments to tenant name, please don't specify tenant name`

### 含义

登陆用户租户执行切换命令时，不能指定租户名，只能默认为当前用户租户。

### 处理方法

去掉命令中的 `TENANT tenant_name`，并重新执行切换命令。

## 报错信息 6：

* `the tenant has ls replicas without leader, switchover to primary is not allowed`

* `the tenant has ls replicas without leader, failover to primary is not allowed`

### 含义

当前租户有日志流无主。

### 处理方法

1. 登录当前租户所在集群的 `sys` 租户，执行以下 SQL，获取没有 Leader 的日志流列表。

    ```sql
    SELECT DISTINCT A.TENANT_ID, A.LS_ID
    FROM CDB_OB_LS A LEFT JOIN oceanbase.GV$OB_LOG_STAT B ON A.LS_ID = B.LS_ID
    AND A.TENANT_ID = B.TENANT_ID AND B.ROLE='LEADER'
    WHERE B.LS_ID IS NULL
      AND A.STATUS NOT IN ('CREATING',
                          'CREATED',
                          'TENANT_DROPPING',
                          'CREATE_ABORT',
                          'PRE_TENANT_DROPPING')
      AND A.TENANT_ID IN (user_tenant_id, user_tenant_id - 1);
    ```

    其中，`user_tenant_id` 需要替换为目标租户的 `TENANT_ID`。

    如果查询结果不为空，则表示租户有日志流无主。

2. 根据查询结果，联系技术支持协助处理。

## 报错信息 7：

* `the tenant has units on temporary offline servers, switchover to primary is not allowed`

* `the tenant has units on temporary offline servers, failover to primary is not allowed`

### 含义

租户有 Unit 在临时下线的机器上，需要等机器永久下线，并且需要保证租户没有副本在永久下线的机器上才可以执行备切主命令。

### 处理方法

1. 登录备租户所在集群的 `sys` 租户。

2. 查询有租户 Unit 的临时下线机器，并获取机器的 `LAST_OFFLINE_TIME`。

   ```sql
   SELECT SVR_IP, SVR_PORT, LAST_OFFLINE_TIME, NOW() FROM DBA_OB_SERVERS WHERE LAST_OFFLINE_TIME IS NOT NULL AND (SVR_IP, SVR_PORT) IN ( SELECT DISTINCT SVR_IP, SVR_PORT FROM oceanbase.DBA_OB_UNITS WHERE TENANT_ID = user_tenant_id);
   ```

   其中，`user_tenant_id` 需要替换为目标租户的 `TENANT_ID`。

   查询结果的示例如下：

   ```shell
   +----------------+----------+----------------------------+---------------------+
   | SVR_IP         | SVR_PORT | LAST_OFFLINE_TIME          | NOW()               |
   +----------------+----------+----------------------------+---------------------+
   | xxx.xx.xxx.212 |    13326 | 2023-12-07 10:44:53.928742 | 2023-12-07 15:58:26 |
   +----------------+----------+----------------------------+---------------------+
   ```

3. 查询配置项 `server_permanent_offline_time` 的值，再根据获取的 `LAST_OFFLINE_TIME` 与配置项的值，判断机器的永久下线时间。

    集群级配置项 `server_permanent_offline_time` 用于设置节点心跳中断的时间阈值，即节点心跳中断多久后认为其被永久下线，永久下线的节点上的数据副本需要被自动补足。有关该配置项的更多详细信息，参见 [server_permanent_offline_time](../../../700.reference/800.configuration-items-and-system-variables/100.system-configuration-items/300.cluster-level-configuration-items/19000.server_permanent_offline_time.md)。

    ```sql
    obclient [oceanbase]> SHOW PARAMETERS LIKE 'server_permanent_offline_time';
    ```

    根据查询结果，如果 `LAST_OFFLINE_TIME + server_permanent_offline_time` 大于 `NOW()` ，则表示机器已经永久下线了，否则机器就是临时下线。

4. 对于机器临时下线的场景，需要排查机器临时下线的原因，如果确认临时下线符合预期，可以通过修改配置项 `server_permanent_offline_time` 的值来修改机器的永久下线时间，待租户没有副本在永久下线的机器上后，重新执行角色切换命令；如果机器临时下线不符合预期，请联系技术支持人员处理。

   1. 修改配置项 `server_permanent_offline_time` 的值，使临时下线机器满足永久下线条件，但不可设置过小，推荐至少要在 20s 以上。
   
      示例如下：

      ```sql
      ALTER SYSTEM SET server_permanent_offline_time = '30s';
      ```

   2. 修改成功后，再执行以下 SQL，确认永久下线机器上是否还有租户副本。

      ```sql
      SELECT * FROM oceanbase.CDB_OB_LS_LOCATIONS WHERE TENANT_ID = user_tenant_id AND SVR_IP = permanent_offline_server_ip AND SVR_PORT = permanent_offline_server_port;
      ```

      其中：

      * `user_tenant_id` 需要替换为目标租户的 TENANT_ID。

      * `permanent_offline_server_ip` 需要替换为永久下线机器的 IP。

      * `permanent_offline_server_port` 需要替换为永久下线机器的 RPC 端口号。

      查询结果为空，则表示永久下线机器上已不存在租户副本。

## 报错信息 8：wait tenant sync to latest failed(original error code: -4179), switchover to primary is not allowed

### 含义

仅在执行 `SWITCHOVER TO PRIMARY VERIFY` 命令时，会出现该报错。

当备租户与恢复源的日志不同步时，无法对该租户执行备切主命令。

### 处理方法

* 基于网络的物理备库的处理方法

   1. 检查主备租户间网络的联通状态。

      如果确认网络联通没有问题，继续执行下一步。

   2. 租户管理员登录当前租户，增加语句执行的超时时间。

      系统变量 `ob_query_timeout` 用于设置 SQL 语句的最大执行时间，默认值为 10000000，单位是为微秒。您可以将其修改为 30000000，即 30 秒。

      ```sql
      SET ob_query_timeout = 30000000;
      ```

   3. 修改成功后，如果仍然报错，请联系技术支持人员协助处理。


* 基于日志归档的物理备库的处理方法

   1. 租户管理员登录当前租户。
   
   2. 检查当前租户状态是否正常。

      :::tab
      tab MySQL 模式

      MySQL 模式下，通过以下 SQL 查看当前租户的状态。

      ```sql
      SELECT TENANT_ROLE, STATUS, SWITCHOVER_STATUS FROM oceanbase.DBA_OB_TENANTS;
      ```

      tab Oracle 模式

      Oracle 模式下，通过以下 SQL 查看当前租户的状态。

      ```sql
      SELECT TENANT_ROLE, STATUS, SWITCHOVER_STATUS FROM SYS.DBA_OB_TENANTS;
      ```

      :::

      根据查询结果，如果查询结果为如下所示，则表示租户状态正常，可以执行下一步。否则，租户状态异常。

      ```shell
      +-------------+--------+-------------------+
      | TENANT_ROLE | STATUS | SWITCHOVER_STATUS |
      +-------------+--------+-------------------+
      | STANDBY     | NORMAL | NORMAL            |
      +-------------+--------+-------------------+
      ```

      对于租户状态异常的场景：

      * 如果当前租户的 `TENANT_ROLE` 不是 `STANDBY`，则需要先将该租户切为备租户。

      * 如果当前租户的 `STATUS` 不是 `NORMAL`，则需要排查租户状态不是 `NORMAL` 的原因，租户可能还在创建中或恢复中，可以等待租户创建完成，或联系技术支持人员协助处理。

      * 如果当前租户的 `SWITCHOVER_STATUS` 不是 `NORMAL`，则需要排查租户的 `SWITCHOVER_STATUS` 处于当前状态的原因，并联系技术支持人员协助处理。

   3. 增加语句执行的超时时间。

      系统变量 `ob_query_timeout` 用于设置 SQL 语句的最大执行时间，默认值为 10000000，单位是为微秒。您可以将其修改为 30000000，即 30 秒。

      ```sql
      SET ob_query_timeout = 30000000;
      ```

   4. 修改成功后，如果仍然报错，请联系技术支持人员协助处理。