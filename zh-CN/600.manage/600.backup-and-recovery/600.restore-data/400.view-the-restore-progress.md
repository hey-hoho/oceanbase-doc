# 查看恢复进度

数据恢复过程中，可以通过视图查看恢复进度。

## 查看物理恢复的恢复进度

1. 使用 `root` 用户登录待恢复租户所在集群的 `sys` 租户。

2. 执行以下语句，查看恢复进度。 

   ```sql
   obclient [oceanbase]> SELECT * FROM oceanbase.CDB_OB_RESTORE_PROGRESS\G
   ```

   查询结果的示例如下：

   ```shell
   *************************** 1. row ***************************
                         TENANT_ID: 1
                            JOB_ID: 1
               RESTORE_TENANT_NAME: mysql
                 RESTORE_TENANT_ID: 1002
                BACKUP_TENANT_NAME: backup_tenant
                  BACKUP_TENANT_ID: 1002
               BACKUP_CLUSTER_NAME: backup_cluster
                       BACKUP_DEST: file:///data/nfs/backup//archive,file:///data/nfs/backup/data
                    RESTORE_OPTION: pool_list=small_pool_2&primary_zone=z1
                       RESTORE_SCN: 1658285759724047000
               RESTORE_SCN_DISPLAY: 2022-06-1 02:55:59.724047
                            STATUS: WAIT_TENANT_RESTORE_FINISH
                   START_TIMESTAMP: 2022-06-1 10:58:33.689560
                   BACKUP_SET_LIST: file:///data/nfs/backup/data/backup_set_1_full
                 BACKUP_PIECE_LIST: file:///data/nfs/backup/archive/2_1_2,file:///data/nfs/backup/archive/2_1_3
                       TOTAL_BYTES: NULL
               TOTAL_BYTES_DISPLAY: NULL
                      FINISH_BYTES: NULL
              FINISH_BYTES_DISPLAY: NULL
                       DESCRIPTION:
   *************************** 2. row ***************************
                         TENANT_ID: 1002
                            JOB_ID: 1
               RESTORE_TENANT_NAME: mysql
                 RESTORE_TENANT_ID: 1002
                BACKUP_TENANT_NAME: backup_tenant
                  BACKUP_TENANT_ID: 1002
               BACKUP_CLUSTER_NAME: backup_cluster
                       BACKUP_DEST: file:///data/nfs/backup//archive,file:///data/nfs/backup/data
                    RESTORE_OPTION: pool_list=small_pool_2&primary_zone=z1
                       RESTORE_SCN: 1658285759724047000
               RESTORE_SCN_DISPLAY: 2022-06-1 02:55:59.724047
                            STATUS: RESTORING
                   START_TIMESTAMP: 2022-06-1 10:58:33.689560
                   BACKUP_SET_LIST: file:///data/nfs/backup/data/backup_set_1_full
                 BACKUP_PIECE_LIST: file:///data/nfs/backup/archive/2_1_2,file:///data/nfs/backup/archive/2_1_3
                       TOTAL_BYTES: 313158553
               TOTAL_BYTES_DISPLAY: 298.65MB
                      FINISH_BYTES: 0
              FINISH_BYTES_DISPLAY: 0.00MB
                       DESCRIPTION:
   2 rows in set
   ```

   该视图记录了恢复时用户输入的相关参数，以及恢复的进度等信息。

   一次租户恢复对应两条任务记录: `sys` 租户的任务记录和被恢复租户的任务记录。 `sys` 租户的任务记录主要记录被恢复租户的恢复相关信息，被恢复租户的任务记录主要记录其自身的恢复进度信息。

   在恢复期间，主要关注恢复进度视图中的 `status` 字段：

   * 系统租户：

      * `CREATE_TENANT` : 创建租户，此阶段系统租户创建被恢复租户。 租户创建完成, 状态变更为 `WAIT_TENANT_RESTORE_FINISH`；创建失败，则变更为 `RESTORE_FAIL`。

      * `WAIT_TENANT_RESTORE_FINISH` : 等待被恢复租户的恢复结束。租户恢复完成, 状态变更为 `RESTORE_SUCCESS`； 恢复失败，则变更为 `RESTORE_FAIL`。

      * `RESTORE_SUCCESS` : 恢复租户成功。

      * `RESTORE_FAIL` : 恢复租户失败。

   * 被恢复租户：

      * `RESTORING` : 租户数据恢复中。恢复完成，状态会变更为 `POST_CHECK`；如果恢复失败，状态会变更为 `RESTORE_FAIL`。

      * `POST_CHECK`: 检查租户角色，恢复成备库。操作完成，状态变更为: `UPGRADE`； 操作失败，状态变更为 `RESTORE_FAIL`。

      * `UPGRADE` : 升级阶段。如果是跨版本恢复，租户会执行升级流程。操作完成，状态变更为: `RESTORE_SUCCESS`；操作失败，状态变更为 `RESTORE_FAIL`。

      * `RESTORE_SUCCESS` : 表示恢复成功。

      * `RESTORE_FAIL` : 表示恢复失败。

   更多关于 `CDB_OB_RESTORE_PROGRESS` 视图的介绍，请参见 [恢复视图](../600.restore-data/900.views-of-the-restore.md)。

   待恢复完成后，可以查看恢复结果，具体操作请参见 [查看恢复结果](../600.restore-data/500.view-the-restore-history.md)。

## 查看指定表的恢复进度

表的恢复过程主要包含以下两个任务：恢复任务和导入任务。恢复任务负责从备份数据中将指定时间点的数据恢复到辅助租户中；导入任务负责将指定的表从辅助租户跨租户导入到目标租户中。

1. 使用 `root` 用户登录表待恢复的目标租户所在集群的 `sys` 租户。

2. 根据实际情况，分别执行以下语句，查看表恢复任务的进度。

   * 查看表恢复任务的相关信息。

      ```sql
      obclient [(none)]> SELECT * FROM oceanbase.CDB_OB_RECOVER_TABLE_JOBS\G
      ```

      查询结果的示例如下：

      ```shell
      *************************** 1. row ***************************
                  TENANT_ID: 1
                     JOB_ID: 1
        INITIATOR_TENANT_ID: 1
           INITIATOR_JOB_ID: 0
            START_TIMESTAMP: 2023-06-01 06:00:00.000000
                     STATUS: RECOVERING
            AUX_TENANT_NAME: AUX_RECOVER$1692106995896258
         TARGET_TENANT_NAME: backup_tenant
                 IMPORT_ALL: 0
                    DB_LIST: 
                 TABLE_LIST: `TEST`.`T1`
                RESTORE_SCN: 1692104831498747191
        RESTORE_SCN_DISPLAY: 2023-06-01 00:00:00.000000
             RESTORE_OPTION: pool_list=small_pool_0&primary_zone=z1
                BACKUP_DEST: file:///data2/nfs/ob_backup_oracle_tenant/archive,file:///data2/nfs/ob_backup_oracle_tenant/data
            BACKUP_SET_LIST: file:///data2/nfs/ob_backup_oracle_tenant/data/backup_set_1_full
          BACKUP_PIECE_LIST: file:///data2/nfs/ob_backup_oracle_tenant/archive/piece_d1001r1p1
              BACKUP_PASSWD: NULL
          EXTERNAL_KMS_INFO: NULL
              REMAP_DB_LIST: 
           REMAP_TABLE_LIST: `TEST`.`T1`:`RECOVER_TEST`.`T3`
      REMAP_TABLEGROUP_LIST:
      REMAP_TABLESPACE_LIST:
                     RESULT: 
                    COMMENT: 
      1 row in set
      ```

     该视图记录了执行恢复时用户输入的恢复参数信息以及恢复结果等信息。

     一条表级恢复命令对应两条任务记录: `sys` 租户的任务记录和目标租户的任务记录。 `sys` 租户的任务记录主要记录恢复任务相关的信息，目标租户的任务记录主要记录跨租户导入任务的信息。
    
   * 恢复过程中，可以查看租户级导入任务的详细信息。 

      ```sql
      obclient [(none)]> SELECT * FROM oceanbase.CDB_OB_IMPORT_TABLE_JOBS\G
      ```

      查询结果的示例如下：

      ```shell
      *************************** 1. row ***************************
                  TENANT_ID: 1010
                     JOB_ID: 3
        INITIATOR_TENANT_ID: 1010
           INITIATOR_JOB_ID: 2
            START_TIMESTAMP: 2023-08-16 17:59:28.689435
            SRC_TENANT_NAME: AUX_RECOVER$1692179849034890
              SRC_TENANT_ID: 1014
                     STATUS: IMPORTING
                 IMPORT_ALL: 0
                    DB_LIST:
                 TABLE_LIST: `TEST`.`T1`
              REMAP_DB_LIST:
           REMAP_TABLE_LIST: `TEST`.`T1`:`RECOVER_TEST`.`T3`
      REMAP_TABLEGROUP_LIST:
      REMAP_TABLESPACE_LIST:
          TOTAL_TABLE_COUNT: 0
       FINISHED_TABLE_COUNT: 0
         FAILED_TABLE_COUNT: 0
                     RESULT:
                    COMMENT:
      1 row in set
      ```

      视图 `CDB_OB_IMPORT_TABLE_JOBS` 记录了跨租户导入任务的详细信息。

   * 导入任务过程中，也可以查看表级别的导入任务的详细信息。     

      ```sql
      obclient [(none)]> SELECT * FROM oceanbase.CDB_OB_IMPORT_TABLE_TASKS\G
      ```

      查询结果的示例如下：

      ```shell
      *************************** 1. row ***************************
                          TENANT_ID: 1002
                            TASK_ID: 1047
                             JOB_ID: 3
                      SRC_TENANT_ID: 1004
                     SRC_TABLESPACE: NULL
                     SRC_TABLEGROUP: NULL
                       SRC_DATABASE: test
                          SRC_TABLE: t1
                      SRC_PARTITION: NULL
                  TARGET_TABLESPACE: NULL
                  TARGET_TABLEGROUP: NULL
                    TARGET_DATABASE: recover_test
                       TARGET_TABLE: t3
                       TABLE_COLUMN: 7
                             STATUS: DOING
                    START_TIMESTAMP: 2023-08-16 21:08:49.492389
               COMPLETION_TIMESTAMP: 
                      CUMULATIVE_TS: -1
                  TOTAL_INDEX_COUNT: 2
               IMPORTED_INDEX_COUNT: 0
                 FAILED_INDEX_COUNT: 0
             TOTAL_CONSTRAINT_COUNT: 1
          IMPORTED_CONSTRAINT_COUNT: 0
            FAILED_CONSTRAINT_COUNT: 0
         TOTAL_REF_CONSTRAINT_COUNT: 1
      IMPORTED_REF_CONSTRAINT_COUNT: 0
        FAILED_REF_CONSTRAINT_COUNT: 0
                             RESULT: 
                            COMMENT:
      1 row in set
      ```

 
   有关 `CDB_OB_RECOVER_TABLE_JOBS`、`CDB_OB_IMPORT_TABLE_JOBS`、`CDB_OB_IMPORT_TABLE_TASKS` 等视图中字段的详细说明，请参见 [物理恢复相关视图介绍](900.views-of-the-restore.md)。




