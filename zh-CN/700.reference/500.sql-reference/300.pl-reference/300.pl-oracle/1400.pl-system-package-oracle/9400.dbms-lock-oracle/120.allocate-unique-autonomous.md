# ALLOCATE_UNIQUE_AUTONOMOUS

`ALLOCATE_UNIQUE_AUTONOMOUS` 存储过程用于申请一个用户锁，用户需要指定锁名称 `lockname`。第一次申请时，会在表 `DBMS_LOCK_ALLOCATED` 中记录下申请到的锁，并返回 `lockhandle`。后续再申请时，如果已经存在相应记录，则直接返回 Lock Handle，也即两次申请对应的是同一把锁。

用户锁会超时，超时时间由 `expiration_secs` 指定。超时以后，`DBMS_LOCK_ALLOCATED` 表中相应的记录会被删除。再次申请到的同名用户锁，将是另外一把锁，和先前的用户锁无关。

## 语法

```shell
DBMS_LOCK.ALLOCATE_UNIQUE_AUTONOMOUS (
   lockname         IN  VARCHAR2,
   lockhandle       OUT VARCHAR2,
   expiration_secs  IN  INTEGER   DEFAULT 864000);
```

## 参数解释

| 参数 | 描述 |
| --- | --- |
| lockname | 锁名称。需要注意，不要以 `ORA$` 开头。 |
| lockhandle | 返回 `ALLOCATE_UNIQUE` 生成的锁 ID 的句柄，可以进行 `REQUEST`、`CONVERT`、 `RELEASE` 操作。任何一个 Session 通过 `ALLOCATE_UNIQUE` 用相同锁名字获取到的 Lock Handle 都指向同一把锁。因此，不要在 Session 间传递 Lock Handle。`lockhandle` 最大长度为 `VARCHAR2 (128)`。 |
| expiration_secs | 通过 `ALLOCATE_UNIQUE` 申请的锁，都在 `DBMS_LOCK_ALLOCATED` 表中保存了记录，`expiration_secs` 指定了该记录的保留时间，即该时间内对应的锁映射不会被清理掉。默认超时时间是 10 天。`ALLOCATE_UNIQUE` 会自动清理超期的锁，所以不应该手动删除 `DBMS_LOCK_ALLOCATED` 表中的数据。 |

## 注意事项

第一个使用 `ALLOCATE_UNIQUE` 指定锁名字申请 Handle 的 Session，将会为该锁名字生成一个唯一的锁 ID，并被保存在表 `DBMS_LOCK_ALLOCATED` 中。后续使用相同锁名字 `ALLOCATE_UNIQUE` 的 Session 将会返回先前已经生成的锁 ID。

锁名和锁 ID 之间的映射会一直保持在 `expiration_secs` 所指定的时间内有效，超期以后，`DBMS_LOCK_ALLOCATED` 中的映射将被清理，以便释放空间。所以，超期以后，之前的锁将失效，以后使用的将是新的锁名字。

## 报错信息

报错信息如下：
`ORA-20000, ORU-10003: Unable to find or insert lock <lockname> into catalog dbms_lock_allocated.`

## 示例
