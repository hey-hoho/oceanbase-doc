# TRANSFER PARTITION

## 描述

`ALTER SYSTEM TRANSFER PARTITION` 语句用于将指定分区表的分片迁移至指定的逻辑服务器。


## 语法

```sql
ALTER SYSTEM TRANSFER PARTITION TABLE_ID [=] $table_id, OBJECT_ID [=] $object_id TO LS $ls_id [tenant = '$tenant_name']
```

## 使用限制及注意事项
1) 仅主租户才能执行 `ALTER SYSTEM TRANSFER PARTITION` 命令。
2) 当租户内的配置项 `enable_transfer` 为 `false` 时，执行 `ALTER SYSTEM TRANSFER PARTITION` 会报错，已经在执行的分区迁移操作可能会被取消。
3) 不支持对系统表进行分区迁移操作。


## 参数解释

|    **参数**   |      **描述**          |
|---------------|------------------------|
| $table_id    | 待迁移的分区表的表 ID。    |
| $object_id  | 待迁移的分区表的唯一标识，支持整数型。 |
| $ls_id            | Transfer Partition 目的端的日志流 ID。  |
| $tenant_name      | 租户名，在系统租户下执行该 SQL 语句时必须指定租户名。  |

## 示例

1) 通过 `DBA_OB_TENANTS` 视图获取 `oracle001` 租户的 `TENANT_ID`。

    ```sql
    obclient> SELECT TENANT_ID FROM DBA_OB_TENANTS WHERE TENANT_NAME = 'oracle001';
    +-----------+
    | TENANT_ID |
    +-----------+
    |      1004 |
    +-----------+
    ```


2) 系统租户可以通过 `CDB_OB_TABLE_LOCATIONS` 视图查询表 `__idx_437_idx_rls_group_table_id` 的 `TABLE_ID`，`OBJECT_ID` 和 `LS_ID`。

    ```sql
    obclient> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID, PARTITION_NAME, SUBPARTITION_NAME FROM CDB_OB_TABLE_LOCATIONS WHERE DATABASE_NAME = 'oceanbase' AND TABLE_NAME= '__idx_437_idx_rls_group_table_id' LIMIT 1;
    +----------+-----------+-----------+-------+----------------+-------------------+
    | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID | PARTITION_NAME | SUBPARTITION_NAME |
    +----------+-----------+-----------+-------+----------------+-------------------+
    |   101085 |    101085 |    101085 |     1 | NULL           | NULL              |
    +----------+-----------+-----------+-------+----------------+-------------------+
    ```

3) 通过 `CDB_OB_LS` 视图获取日志流状态和信息，通过 `CDB_OB_TABLET_TO_LS` 获取日志流上 `TABLET` 分布信息，然后选择合适的日志流作为 transfer 目的端。

    ```sql
    obclient> SELECT * FROM CDB_OB_LS WHERE TENANT_ID = 1004;
    +-----------+-------+--------+-------------------+---------------+-------------+---------------------+----------        +---------------------+---------------------+------+
    | TENANT_ID | LS_ID | STATUS | PRIMARY_ZONE      | UNIT_GROUP_ID | LS_GROUP_ID | CREATE_SCN          | DROP_SCN | SYNC_SCN            | READABLE_SCN        | FLAG |
    +-----------+-------+--------+-------------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
    |      1004 |     1 | NORMAL | zone1;zone2;zone3 |             0 |           0 |                NULL |     NULL | 1701157989111767716 | 1701157989111767716 |      |
    |      1004 |  1001 | NORMAL | zone1;zone2;zone3 |          1002 |        1001 | 1701056165154738336 |     NULL | 1701157989111767716 | 1701157989111767716 |      |
    +-----------+-------+--------+-------------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
    
    obclient> SELECT * FROM CDB_OB_TABLET_TO_LS WHERE TENANT_ID = 1002 GROUP BY LS_ID;
    +-----------+-----------+-------+
    | TENANT_ID | TABLET_ID | LS_ID |
    +-----------+-----------+-------+
    |      1002 |         1 |     1 |
    +-----------+-----------+-------+
    ```

4) 选取合适的目的端后，可以执行 transfer partition 任务了。例如将 `TABLE_ID` 为 `101085` , `OBJECT_ID` 为 `101085` 的分片迁移到 `1001` 日志流上，所属租户为 `oracle001`。

    ```sql
    obclient> ALTER SYSTEM TRANSFER PARTITION TABLE_ID = 101085, OBJECT_ID = 101085 TO LS 1001 tenant = 'oracle001';
    ```

5) 通过视图 `CDB_OB_TRANSFER_PARTITION_TASKS` 查询任务的 `task_id`。

    ```sql
    obclient> SELECT TASK_ID, BALANCE_JOB_ID, TRANSFER_TASK_ID FROM CDB_OB_TRANSFER_PARTITION_TASKS WHERE TENANT_ID = 1002 AND TABLE_ID = 3 AND OBJECT_ID = 3;
    ```

6) 通过视图 `CDB_OB_BALANCE_JOBS/DBA_OB_BALANCE_JOBS/CDB_OB_BALANCE_JOB_HISTORY/DBA_OB_BALANCE_JOB_HISTORY` 查询关联的`balance_job` 执行的状态。`job_id` 是步骤五中查询到的 `BALANCE_JOB_ID`。

    ```sql
    obclient> SELECT * FROM CDB_OB_BALANCE_JOBS WHERE JOB_ID = $BALANCE_JOB_ID;
    ```

7) 通过视图 `CDB_OB_TRANSFER_TASKS/DBA_OB_TRANSFER_TASKS/CDB_OB_TRANSFER_TASK_HISTORY/DBA_OB_TRANSFER_TASK_HISTORY` 查询任务关联的 `transfer task` 的执行状态。`task_id` 是步骤五中查询到的 `TRANSFER_TASK_ID`。

    ```sql
    obclient> SELECT * FROM CDB_OB_BALANCE_JOBS WHERE JOB_ID = $BALANCE_JOB_ID;
    ```

8) 通过视图 `CDB_OB_TRANSFER_PARTITION_TASK_HISTORY/DBA_OB_TRANSFER_PARTITION_TASK_HISTORY` 查询该`transfer partition task` 的结果。`task_id` 是步骤五中查询到的 `TASK_ID`。

    ```sql
    SELECT * FROM CDB_OB_TRANSFER_PARTITION_TASK_HISTORY WHERE TASK_ID = $TASK_ID;
    ```

