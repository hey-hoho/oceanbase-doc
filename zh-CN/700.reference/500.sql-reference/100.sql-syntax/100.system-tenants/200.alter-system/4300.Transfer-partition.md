# TRANSFER PARTITION

## 描述

`ALTER SYSTEM TRANSFER PARTITION` 语句用于将指定分区表的分片迁移至指定的逻辑服务器。


## 语法

```sql
ALTER SYSTEM TRANSFER PARTITION TABLE_ID [=] $table_id, OBJECT_ID [=] $object_id TO LS $ls_id [tenant = '$tenant_name']
```

## 使用限制及注意事项
1) 仅主租户才能执行 `ALTER SYSTEM TRANSFER PARTITION` 命令。
2) 当租户内的配置项 `enable_transfer` 为 `false` 时，执行 `ALTER SYSTEM TRANSFER PARTITION` 会报错，已经在执行的分区迁移操作可能会被取消。
3) 不支持对系统表进行分区迁移操作。
4) 不支持将普通表迁移到复制日志流上，也不支持将复制表迁移到普通日志流。
5) 不支持迁移非独立的分区，例如，不支持迁移局部索引表和lob表的分区。
6) 一个分区的 `transfer partition task` 在没有结束之前，不允许再次发起。
7) 多个 `transfer partition` 任务会被聚集成一个 `balance_job`，因此用户触发的 `transfer partition` 任务并不会立刻开始调度，需要在队列中等待任务依次执行。
8) `transfer partition` 不受配置项`enable_rebalance` 控制，在 `enable_rebalance` 打开的场景下，可能存在用户将一个分区迁移到对应的日志流上后，被自动均衡的逻辑 transfer 到其他的地方去的情况。



## 参数解释

|    **参数**   |      **描述**          |
|---------------|------------------------|
| $table_id    | 待迁移的分区表的表 ID。    |
| $object_id  | 待迁移的分区表的唯一标识，支持整数型。 |
| $ls_id            | Transfer Partition 目的端的日志流 ID。  |
| $tenant_name      | 租户名，在系统租户下执行该 SQL 语句时必须指定租户名。  |

## 示例

1) 系统租户通过 `DBA_OB_TENANTS` 视图获取 `oracle001` 租户的 `TENANT_ID`。

    ```sql
    obclient> SELECT TENANT_ID FROM DBA_OB_TENANTS WHERE TENANT_NAME = 'oracle001';
    +-----------+
    | TENANT_ID |
    +-----------+
    |      1006 |
    +-----------+
    ```


2) 系统租户可以通过 `CDB_OB_TABLE_LOCATIONS` 视图查询表 `T101` 的 `TABLE_ID`，`OBJECT_ID` 和 `LS_ID`。

    ```sql
    obclient> SELECT TABLE_ID AS TABLE_ID, OBJECT_ID, TABLET_ID, LS_ID FROM CDB_OB_TABLE_LOCATIONS WHERE TENANT_ID = 1006 AND TABLE_NAME= 'T101' LIMIT 1;
    +----------+-----------+-----------+-------+
    | TABLE_ID | OBJECT_ID | TABLET_ID | LS_ID |
    +----------+-----------+-----------+-------+
    |   500026 |    500026 |    200020 |  1002 |
    +----------+-----------+-----------+-------+
    ```

3) 系统租户通过 `CDB_OB_LS` 视图获取日志流状态和信息，通过 `CDB_OB_TABLET_TO_LS` 获取日志流上 `TABLET` 分布信息，然后选择合适的日志流作为 transfer 目的端。

    ```sql
    obclient> SELECT * FROM CDB_OB_LS WHERE TENANT_ID = 1006;
    +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
    | TENANT_ID | LS_ID | STATUS | PRIMARY_ZONE | UNIT_GROUP_ID | LS_GROUP_ID | CREATE_SCN          | DROP_SCN | SYNC_SCN            | READABLE_SCN        | FLAG |
    +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
    |      1006 |     1 | NORMAL | zone1        |             0 |           0 |                NULL |     NULL | 1701314066791070653 | 1701314066791070653 |      |
    |      1006 |  1001 | NORMAL | zone1        |          1006 |        1001 | 1701239786827662637 |     NULL | 1701314066791070653 | 1701314066791070653 |      |
    |      1006 |  1002 | NORMAL | zone1        |          1007 |        1002 | 1701239786831568305 |     NULL | 1701314066324263349 | 1701314066324263349 |      |
    |      1006 |  1003 | NORMAL | zone1        |          1008 |        1003 | 1701239786834300282 |     NULL | 1701314066441665106 | 1701314066441665106 |      |
    |      1006 |  1005 | NORMAL | zone1        |          1007 |        1002 | 1701313462717904877 |     NULL | 1701314066457286236 | 1701314066324263349 |      |
    +-----------+-------+--------+--------------+---------------+-------------+---------------------+----------+---------------------+---------------------+------+
    
    obclient> SELECT * FROM CDB_OB_TABLET_TO_LS WHERE TENANT_ID = 1006 GROUP BY LS_ID;
    +-----------+-----------+-------+
    | TENANT_ID | TABLET_ID | LS_ID |
    +-----------+-----------+-------+
    |      1006 |         1 |     1 |
    |      1006 |    200001 |  1001 |
    |      1006 |    200006 |  1003 |
    |      1006 |    200007 |  1002 |
    +-----------+-----------+-------+
    ```

4) 选取合适的目的端后，可以执行 `transfer partition` 任务了。例如将 `TABLE_ID` 为 `500026` , `OBJECT_ID` 为 `500026` 的分片迁移到 `1001` 日志流上，所属租户为 `oracle001`。

    ```sql
    obclient> ALTER SYSTEM TRANSFER PARTITION TABLE_ID = 500026, OBJECT_ID = 500026 TO LS 1001 tenant = 'oracle001';
    ```

5) 通过视图 `CDB_OB_TRANSFER_PARTITION_TASKS` 查询任务的 `task_id`。

    ```sql
    obclient> SELECT TASK_ID, BALANCE_JOB_ID, TRANSFER_TASK_ID FROM CDB_OB_TRANSFER_PARTITION_TASKS WHERE TENANT_ID = 1006 AND TABLE_ID = 500026 AND OBJECT_ID = 500026;
    +---------+----------------+------------------+
    | TASK_ID | BALANCE_JOB_ID | TRANSFER_TASK_ID |
    +---------+----------------+------------------+
    |       2 |         377170 |             1047 |
    +---------+----------------+------------------+
    ```

6) 通过视图 `CDB_OB_BALANCE_JOBS/DBA_OB_BALANCE_JOBS/CDB_OB_BALANCE_JOB_HISTORY/DBA_OB_BALANCE_JOB_HISTORY` 查询关联的`balance_job` 执行的状态。此处的 `job_id` 是步骤五中查询到的 `BALANCE_JOB_ID`。

    ```sql
    obclient> SELECT * FROM CDB_OB_BALANCE_JOBS WHERE JOB_ID = $BALANCE_JOB_ID;
    +-----------+--------+----------------------------+----------------------------+---------------------------+--------------------+-----------------+-------------------------+--------+---------+
    | TENANT_ID | JOB_ID | CREATE_TIME                | MODIFY_TIME                | BALANCE_STRATEGY          | JOB_TYPE           | TARGET_UNIT_NUM | TARGET_PRIMARY_ZONE_NUM | STATUS | COMMENT |
    +-----------+--------+----------------------------+----------------------------+---------------------------+--------------------+-----------------+-------------------------+--------+---------+
    |      1006 | 377170 | 2023-11-30 11:04:21.739021 | 2023-11-30 11:04:21.739021 | manual transfer partition | TRANSFER_PARTITION |               3 |                       1 | DOING  | NULL    |
    +-----------+--------+----------------------------+----------------------------+---------------------------+--------------------+-----------------+-------------------------+--------+---------+

    ```

7) 通过视图 `CDB_OB_TRANSFER_TASKS/DBA_OB_TRANSFER_TASKS/CDB_OB_TRANSFER_TASK_HISTORY/DBA_OB_TRANSFER_TASK_HISTORY` 查询任务关联的 `transfer task` 的执行状态。此处的 `task_id` 是步骤五中查询到的 `TRANSFER_TASK_ID`。

    ```sql
    obclient> SELECT * FROM CDB_OB_TRANSFER_TASKS WHERE TASK_ID = $TRANSFER_TASK_ID;
    ```

8) 通过视图 `CDB_OB_TRANSFER_PARTITION_TASK_HISTORY/DBA_OB_TRANSFER_PARTITION_TASK_HISTORY` 查询该`transfer partition task` 的结果。此处的 `task_id` 是步骤五中查询到的 `TASK_ID`。

    ```sql
    SELECT * FROM CDB_OB_TRANSFER_PARTITION_TASK_HISTORY WHERE TASK_ID = $TASK_ID;
    ```

