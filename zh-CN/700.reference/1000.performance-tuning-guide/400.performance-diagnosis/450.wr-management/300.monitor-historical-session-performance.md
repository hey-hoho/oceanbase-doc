# 监测历史会话性能

WR 通过定期采集性能视图的数据信息，将所采集的 ASH、统计信息、等待事件和 SQL 执行情况等数据进行持久化和展示。

## 查看历史会话性能

* 通过 `oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY` 视图查看所有租户持久化后的 ASH 数据。

  ```sql
  obclient [oceanbase]> SELECT * FROM oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY limit 1;
  ```

    返回结果如下：

    ```sql
    +------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
    | cluster_id | tenant_id | snap_id | svr_ip    | svr_port | smaple_id | session_id | SAMPLE_TIME                | USER_ID | SESSION_TYPE | SESSION_STATE | SQL_ID                           | TRACE_ID                           | EVENT_NO | TIME_WAITED | P1   | P2   | P3   | SQL_PLAN_LINE_ID | TIME_MODEL | IN_PARSE | IN_PL_PARSE | IN_PLAN_CACHE | IN_SQL_OPTIMIZE | IN_SQL_EXECUTION | IN_PX_EXECUTION | IN_SEQUENCE_LOAD | MODULE | ACTION | CLIENT_ID | BACKTRACE                                                                                                                                                                                                                                                       | PLAN_ID |
    +------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
    |          1 |      1004 |    4373 | xx.xx.xx.xx |    49700 |         1 | 3221487621 | 2023-08-06 11:42:54.970554 |  200001 |            0 |             0 | B9866D3A1A68153AD58193F60CCD40AA | YC225645868B4-0005F816208F16B9-0-0 |       20 |       89267 |  592 |  378 |    0 |             NULL |          1 |        0 |           0 |             0 |               0 |                1 |               0 |                0 | NULL   | NULL   | NULL      | 0x11882b55 0x113d68b3 0x113d680a 0x42a89e6 0x455534d 0x538cf24 0x538bfd8 0x538bcc2 0x52a3673 0xa35d2a0 0xa35b8f0 0x92a2537 0x4313d3b 0x43125e2 0x4244faf 0x422e878 0x435a80d 0x4201726 0x41fd8dc 0x41fb111 0x71a8caa 0x41facb3 0x71a7a21 0x41f9c9a 0x71a80fc 0x |    1453 |
    +------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
    ```

    有关 oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY 视图的更多信息，请参见 [oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY](../../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/24900.cdb_wr_active_session_history-of-sys-tenant.md)。

* 通过 `oceanbase.DBA_WR_ACTIVE_SESSION_HISTORY` 视图查看本租户持久化后的 ASH 数据。

  ```sql
  obclient [oceanbase]> SELECT * FROM oceanbase.DBA_WR_ACTIVE_SESSION_HISTORY limit 1;
  ```

    返回结果如下：

    ```sql
    +------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
    | cluster_id | tenant_id | snap_id | svr_ip    | svr_port | smaple_id | session_id | SAMPLE_TIME                | USER_ID | SESSION_TYPE | SESSION_STATE | SQL_ID                           | TRACE_ID                           | EVENT_NO | TIME_WAITED | P1   | P2   | P3   | SQL_PLAN_LINE_ID | TIME_MODEL | IN_PARSE | IN_PL_PARSE | IN_PLAN_CACHE | IN_SQL_OPTIMIZE | IN_SQL_EXECUTION | IN_PX_EXECUTION | IN_SEQUENCE_LOAD | MODULE | ACTION | CLIENT_ID | BACKTRACE                                                                                                                                                                                                                                                       | PLAN_ID |
    +------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
    |          1 |      1004 |    4373 | xx.xx.xx.xx |    49700 |         1 | 3221487621 | 2023-08-06 11:42:54.970554 |  200001 |            0 |             0 | B9866D3A1A68153AD58193F60CCD40AA | YC225645868B4-0005F816208F16B9-0-0 |       20 |       89267 |  592 |  378 |    0 |             NULL |          1 |        0 |           0 |             0 |               0 |                1 |               0 |                0 | NULL   | NULL   | NULL      | 0x11882b55 0x113d68b3 0x113d680a 0x42a89e6 0x455534d 0x538cf24 0x538bfd8 0x538bcc2 0x52a3673 0xa35d2a0 0xa35b8f0 0x92a2537 0x4313d3b 0x43125e2 0x4244faf 0x422e878 0x435a80d 0x4201726 0x41fd8dc 0x41fb111 0x71a8caa 0x41facb3 0x71a7a21 0x41f9c9a 0x71a80fc 0x |    1453 |
    +------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
    ```

    有关 DBA_WR_ACTIVE_SESSION_HISTORY 视图的更多信息，请参见 [oceanbase.DBA_WR_ACTIVE_SESSION_HISTORY](../../../700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/24700.dba_wr_active_session_history-of-mysql-mode.md) 和 [DBA_WR_ACTIVE_SESSION_HISTORY](../../../700.system-views/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/31000.dba_wr_active_session_history-of-oracle-mode.md)。

## 查看历史会话统计项

* 通过 `oceanbase.CDB_WR_STATNAME` 视图查看所有租户的系统统计项的名称。

  ```sql
  obclient [oceanbase]> SELECT * FROM oceanbase.CDB_WR_STATNAME limit 1;
  ```

  返回结果如下：

  ```sql
    +------------+-----------+---------+---------------+
    | CLUSTER_ID | TENANT_ID | STAT_ID | STAT_NAME     |
    +------------+-----------+---------+---------------+
    |       4000 |         1 |   10000 | rpc packet in |
    +------------+-----------+---------+---------------+
    1 row in set (0.001 sec)
  ```

    有关 oceanbase.CDB_WR_STATNAME 视图的更多信息，请参见 [oceanbase.CDB_WR_STATNAME](../../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/25100.cdb_wr_statname-of-sys-tenant.md)。

* 通过 `oceanbase.DBA_WR_STATNAME` 视图查看本租户的系统统计项的名称。

  ```sql
  obclient [oceanbase]> SELECT * FROM oceanbase.DBA_WR_STATNAME limit 1;
  ```

  返回结果如下：

  ```sql
    +------------+-----------+---------+---------------+
    | CLUSTER_ID | TENANT_ID | STAT_ID | STAT_NAME     |
    +------------+-----------+---------+---------------+
    |       4000 |         1 |   10000 | rpc packet in |
    +------------+-----------+---------+---------------+
    1 row in set (0.004 sec)
  ```

    有关 DBA_WR_STATNAME 视图的更多信息，请参见 [oceanbase.DBA_WR_STATNAME](../../../700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/24800.dba_wr_statname-of-mysql-mode.md) 和 [DBA_WR_STATNAME](../../../700.system-views/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/31100.dba_wr_statname-of-oracle-mode.md)。

* 通过 `oceanbase.CDB_WR_SYSSTAT` 视图查看所有租户的系统统计项的详细信息。

  ```sql
  obclient [oceanbase]> SELECT * FROM oceanbase.CDB_WR_SYSSTAT limit 1;
  ```

  返回结果如下：

  ```sql
    +------------+-----------+---------+----------------+----------+---------+--------+
    | CLUSTER_ID | TENANT_ID | SNAP_ID | SVR_IP         | SVR_PORT | STAT_ID | VALUE  |
    +------------+-----------+---------+----------------+----------+---------+--------+
    |       4000 |         1 |     114 | xx.xx.xx.xx |     2882 |   10000 | 228856 |
    +------------+-----------+---------+----------------+----------+---------+--------+
    1 row in set (0.036 sec)
  ```

    有关 oceanbase.CDB_WR_SYSSTAT 视图的更多信息，请参见 [oceanbase.CDB_WR_SYSSTAT](../../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/25300.cdb_wr_sysstat-of-sys-tenant.md)。

* 通过 `oceanbase.DBA_WR_SYSSTAT` 视图查看本租户的系统统计项的详细信息。

  ```sql
  obclient [oceanbase]> SELECT * FROM oceanbase.DBA_WR_SYSSTAT limit 1;
  ```

  返回结果如下：

  ```sql
    +------------+-----------+---------+----------------+----------+---------+--------+
    | CLUSTER_ID | TENANT_ID | SNAP_ID | SVR_IP         | SVR_PORT | STAT_ID | VALUE  |
    +------------+-----------+---------+----------------+----------+---------+--------+
    |       4000 |         1 |     114 | xx.xx.xx.xx |     2882 |   10000 | 228856 |
    +------------+-----------+---------+----------------+----------+---------+--------+
    1 row in set (0.026 sec)
  ```

    有关 DBA_WR_STATNAME 视图的更多信息，请参见 [oceanbase.DBA_WR_SYSSTAT](../../../700.system-views/400.system-view-of-mysql-mode/200.dictionary-view-of-mysql-mode/24900.dba_wr_sysstat-of-mysql-mode.md) 和 [DBA_WR_SYSSTAT](../../../700.system-views/500.system-view-of-oracle-mode/200.dictionary-view-of-oracle-mode/31200.dba_wr_sysstat-of-oracle-mode.md)。

## 相关文档

* [WR 概述](100.wr-overview.md)
* [管理 WR](200.manage-wr.md)
* [清理 WR 数据](400.clean-up-wr-data.md)
