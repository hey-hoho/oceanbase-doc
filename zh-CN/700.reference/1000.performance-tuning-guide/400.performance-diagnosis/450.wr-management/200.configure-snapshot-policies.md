# 配置快照策略

WR 提供了 DBMS 包，可以使用该包来调整 WR 的配置。可以通过 PL/SQL 触发手动采集任务或删除指定的 WR 快照。此外，还可以调整定时器线程的时间间隔，以调整 WR 快照的采集频率。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>该功能仅支持在 SYS 租户下使用，并且在升级过程中不可用。</p>
</main>

## 定期快照的开启和使用

通过触发生成一个集群的快照来开启定期快照。在手动创建快照后，定时器将会重新计时。

**命令如下：**

```sql
DBMS_WORKLOAD_REPOSITORY.CREATE_SNAPSHOT(
    flush_level  VARCHAR(64) DEFAULT 'TYPICAL'
    );
```

**参数说明：**

| 字段 | 说明 |
|------|-----|
| flush_level | 目前只支持定期快照 TYPICAL。收集了大部分统计数据 |

**示例如下：**

例如在默认的间隔为 1 小时的情况下开启定期快照：

```sql
obclient [(none)]> CALL DBMS_WORKLOAD_REPOSITORY.CREATE_SNAPSHOT(flush_level => 'TYPICAL');
Query OK, 0 rows affected, 3 warnings (1.112 sec)
```

* 12:21 定时器触发创建快照
* 13:21 定时器触发创建下一个快照
* 13:45 用户手动创建快照
* 14:45 定时器触发创建下一个快照

经过手动创建快照后，定时器会按照设定的间隔继续触发下一次快照的生成。

## 快照间隔和保留时间的设置

通过修改 WR 配置来设置快照间隔和保留时间。

**命令如下：**

```sql
DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS(
   retention          INT    DEFAULT  NULL,
   interval           INT    DEFAULT  NULL
   );
```

**参数说明：**

| 字段 | 说明 |
|------|-----|
| retention | 一个快照的保留时间，超过这个时间的快照将会被自动删除，单位为分钟。取值范围为 [1440 分钟（1 天），52560000 分钟（100 年）]。<ul><li>如果指定值为 0，则表示永久保留，保留时间将设为 57816000 分钟（110 年）  </li><li>如果指定值为 NULL，则保留原来的保留时间 </li></ul>|
| interval | 每个快照之间的间隔设置，单位为分钟。取值范围为 [10 分钟， 525600 分钟（1 年）]。<ul><li>如果指定值为 0，则表示禁用自动和手动快照，并使用一个较大的系统定义值（110 年）作为保留时间</li><li>如果指定值为 NULL，则保留当前的间隔设置</li></ul>|

**示例如下：**

例如设置每个快照的保留时间为 2265 分钟（约 1 天 12 小时），并将每个快照之间的间隔设置为 16 分钟：

```sql
obclient [(none)]> CALL DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS('2265','16');
Query OK, 0 rows affected (0.006 sec)
```

## 快照数据的删除

通过指定要删除的快照范围的起始和结束快照 ID，删除指定范围内的快照数据。

<main id="notice" type='notice'>
  <h4>注意</h4>
  <ol><li>请确保删除的快照 ID 是有效的存在于系统中的快照 ID。</li><li>执行删除操作后，指定范围内的快照数据将被永久删除，请谨慎操作。</li></ol>
</main>

**命令如下：**

```sql
DBMS_WORKLOAD_REPOSITORY.DROP_SNAPSHOT_RANGE(
    low_snap_id    INT,
    high_snap_id   INT
    );
```

**参数说明：**

| 字段 | 说明 |
|------|-----|
| low_snap_id | 要删除的快照的起始快照 ID |
| high_snap_id | 要删除的快照的结束快照 ID |

**示例如下：**

1. 查询租户下的 SNAP_ID。

    ```sql
    obclient [(none)]> select SNAP_ID from oceanbase.DBA_WR_SYSSTAT;
    ```

2. 例如删除快照 ID 从 123 到 456 的范围内的快照数据。

    ```sql
    obclient [(none)]> CALL DBMS_WORKLOAD_REPOSITORY.DROP_SNAPSHOT_RANGE('123','456');
    Query OK, 0 rows affected (1.018 sec)
    ```
