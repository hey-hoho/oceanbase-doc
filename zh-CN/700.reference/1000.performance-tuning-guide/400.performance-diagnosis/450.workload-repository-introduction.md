# WR 特性介绍

## WR 概述

Workload Repository（自动负载信息仓库，简称 WR）通过定期采集 OceanBase 数据库视图的数据信息，记录系统的状态，并提供相关视图用于查看数据库的性能情况。此外，还可以使用 DBMS_WORKLOAD_REPOSITORY 包进行 WR 相关配置调整，包括创建和删除数据快照和修改 WR 配置等功能。

WR 会周期性的记录 OceanBase 数据库的性能数据，因此可以通过 WR 回溯 OceanBase 数据库过往的性能记录，也可以研究某一具体时间段内的性能相关问题。WR 定期采集 OceanBase 数据库的视图主要有以下 3 个：

* **[G]V$SYSSTAT**：oceanbase 数据库中使用最广泛、最能表征数据库运行状况的系统统计值。
* **V$STATNAME**：提供系统统计值的信息，能够准确反映数据库运行状况的各项指标和指标名称。
* **[G]V$ACTIVE_SESSION_HISTORY**：对活跃 Session 每秒采样一次，基于时间序列记录系统的运行状况，WR 会以 10:1 的采样率进行持久化。
在后续版本中 WR 将会支持更多的性能相关的视图，用于展示有关数据库性能、资源利用和其他重要指标的详细信息。

## 功能介绍

WR 用于自动化数据收集和保留历史性能数据，以支持性能监控和管理。WR 功能具有以下的特点：

* 数据自动化与采集：WR 会定期采集指定的性能相关视图，如 `V$ACTIVE_SESSION_HISTORY`、`V$SYSSTAT` 和 `V$STATNAME`，并对数据进行处理后插入到 META 租户的内部表中，实现数据的持久化。**默认情况下，每小时采集一次快照。**

* 数据持久化与清理：采集到的数据会被持久化到磁盘上，以实现历史数据的保留。为了避免 WR 占用过多存储空间，WR 会定期删除过期的数据。通常在每天的合并完成后触发删除操作。**默认情况下，存储超过七天的快照数据被视为过期数据。**

* 快照采集与删除：WR 提供了 DBMS 包，可以通过 PL/SQL 触发手动采集任务或删除指定的 WR 快照。

* 快照采集频率可调整：通过 DBMS 包，可以修改定时器线程的时间间隔，以调整 WR 的快照采集频率。

* 低开销与低负载：WR 在运行时所产生的开销较低，所需的资源消耗和资源使用率很少，不会对系统的性能产生影响。

## 使用示例

### 查看 WR 视图

<main id="notice" type='explain'>
  <h4>说明</h4>
  <p>DBA_* 视图展示本租户数据，CDB_* 视图仅在系统租户下可见，展示所有租户数据。</p>
</main>

#### oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY

展示所有租户持久化后的 ASH 数据。

**示例展示**

从视图中获取一条记录：

```sql
OceanBase(root@oceanbase)>select * from oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY limit 1;
```

返回结果如下：

```sql
+------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
| cluster_id | tenant_id | snap_id | svr_ip    | svr_port | smaple_id | session_id | SAMPLE_TIME                | USER_ID | SESSION_TYPE | SESSION_STATE | SQL_ID                           | TRACE_ID                           | EVENT_NO | TIME_WAITED | P1   | P2   | P3   | SQL_PLAN_LINE_ID | TIME_MODEL | IN_PARSE | IN_PL_PARSE | IN_PLAN_CACHE | IN_SQL_OPTIMIZE | IN_SQL_EXECUTION | IN_PX_EXECUTION | IN_SEQUENCE_LOAD | MODULE | ACTION | CLIENT_ID | BACKTRACE                                                                                                                                                                                                                                                       | PLAN_ID |
+------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
|          1 |      1004 |    4373 | xx.xx.xx.xx |    49700 |         1 | 3221487621 | 2023-08-06 11:42:54.970554 |  200001 |            0 |             0 | B9866D3A1A68153AD58193F60CCD40AA | YC225645868B4-0005F816208F16B9-0-0 |       20 |       89267 |  592 |  378 |    0 |             NULL |          1 |        0 |           0 |             0 |               0 |                1 |               0 |                0 | NULL   | NULL   | NULL      | 0x11882b55 0x113d68b3 0x113d680a 0x42a89e6 0x455534d 0x538cf24 0x538bfd8 0x538bcc2 0x52a3673 0xa35d2a0 0xa35b8f0 0x92a2537 0x4313d3b 0x43125e2 0x4244faf 0x422e878 0x435a80d 0x4201726 0x41fd8dc 0x41fb111 0x71a8caa 0x41facb3 0x71a7a21 0x41f9c9a 0x71a80fc 0x |    1453 |
+------------+-----------+---------+-----------+----------+-----------+------------+----------------------------+---------+--------------+---------------+----------------------------------+------------------------------------+----------+-------------+------+------+------+------------------+------------+----------+-------------+---------------+-----------------+------------------+-----------------+------------------+--------+--------+-----------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------+
```

有关 oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY 视图的更多信息，请参见 [oceanbase.CDB_WR_ACTIVE_SESSION_HISTORY](../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/24900.cdb_wr_active_session_history-of-sys-tenant.md)。

#### oceanbase.DBA_WR_CONTROL

展示 WR 相关的配置信息。

**示例展示**

获取视图信息：

```sql
OceanBase(root@oceanbase)>select * from oceanbase.DBA_WR_CONTROL;
```

返回结果如下：

```sql
+-----------+---------------------+---------------------+------------+
| TENANT_ID | SNAP_INTERVAL       | RETENTION           | TOPNSQL    |
+-----------+---------------------+---------------------+------------+
|         1 | +00 00:12:00.000000 | +14 00:00:00.000000 | 2000000000 |
+-----------+---------------------+---------------------+------------+
1 row in set (0.014 sec)
```

有关 oceanbase.DBA_WR_CONTROL 视图的更多信息，请参见 [oceanbase.DBA_WR_CONTROL](../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/25400.dba_wr_control-of-sys-tenant.md)。

#### oceanbase.DBA_WR_SNAPSHOT

展示本租户的 `SNAPSHOT` 信息。

**示例展示**

从视图中获取一条记录：

```sql
OceanBase(root@oceanbase)>select * from oceanbase.DBA_WR_SNAPSHOT limit 1;
```

返回结果如下：

```sql
+------------+-----------+---------+-----------+----------+----------------------------+----------------------------+-----------+----------------------------+
| cluster_id | tenant_id | snap_id | svr_ip    | svr_port | begin_interval_time        | end_interval_time          | snap_flag | startup_time               |
+------------+-----------+---------+-----------+----------+----------------------------+----------------------------+-----------+----------------------------+
|          1 |      1004 |    4373 | xx.xx.xx.xx |    49700 | 2023-03-30 16:01:33.237489 | 2023-03-30 17:00:19.123512 |         0 | 2023-01-30 16:01:33.237489 |
+------------+-----------+---------+-----------+----------+----------------------------+----------------------------+-----------+----------------------------+
1 row in set (0.001 sec)
```

有关 oceanbase.DBA_WR_SNAPSHOT 视图的更多信息，请参见 [oceanbase.DBA_WR_SNAPSHOT](../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/24600.dba_wr_snapshot-of-sys-tenant.md)。

#### oceanbase.DBA_WR_STATNAME

展示本租户的系统统计项的名称。

**示例展示**

从视图中获取一条记录：

```sql
OceanBase(root@oceanbase)>select * from oceanbase.DBA_WR_STATNAME limit 1;
```

返回结果如下：

```sql
+------------+-----------+---------+---------------------+
| cluster_id | tenant_id | stat_id | stat_name           |
+------------+-----------+---------+---------------------+
|          1 |      1004 |   10000 | rpc packet in       |
+------------+-----------+---------+---------------------+
1 row in set (0.001 sec)
```

有关 oceanbase.DBA_WR_STATNAME 视图的更多信息，请参见 [oceanbase.DBA_WR_STATNAME](../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/25000.dba_wr_statname-of-sys-tenant.md)。

#### oceanbase.DBA_WR_SYSSTAT

展示本租户的持久化后的 ASH 数据。

**示例展示**

从视图中获取一条记录：

```sql
OceanBase(root@oceanbase)>select * from oceanbase.DBA_WR_SYSSTAT limit 1;
```

返回结果如下：

```sql
+------------+-----------+---------+-----------+----------+---------+-------+
| cluster_id | tenant_id | snap_id | svr_ip    | svr_port | stat_id | value |
+------------+-----------+---------+-----------+----------+---------+-------+
|          1 |      1004 |    4373 | xx.xx.xx.xx |    49700 |   10000 |   999 |
+------------+-----------+---------+-----------+----------+---------+-------+
1 row in set (0.001 sec)
```

有关 oceanbase.DBA_WR_SYSSTAT 视图的更多信息，请参见 [oceanbase.DBA_WR_SYSSTAT](../../700.system-views/300.system-view-of-sys-tenant/200.dictionary-view-of-sys-tenant/25200.dba_wr_sysstat-of-sys-tenant.md)。

### 使用 DBMS 包调整 WR 配置

<main id="notice" type='notice'>
  <h4>注意</h4>
  <p>该功能仅在 SYS 租户下可用，用于创建、删除、修改和清理集群的快照。</p>
</main>

#### 创建快照

在 SYS 租户下触发一个集群的快照生成。

```sql
DBMS_WORKLOAD_REPOSITORY.CREATE_SNAPSHOT(
    flush_level  VARCHAR(64) DEFAULT 'TYPICAL'
    );
```

| 字段 | 说明 |
|------|-----|
| flush_level | 目前只支持定期快照 TYPICAL。收集了大部分统计数据 |

用户在手动创建快照后，会将定时器重新计时。例如，在默认的 INTERVAL 为 1 小时的情况下：

* 12:21 定时器触发创建快照
* 13:21 定时器触发创建下一个快照
* 13:45 用户手动创建快照
* 14:45 定时器触发创建下一个快照

#### 删除快照

在 SYS 租户下删除一个范围内的快照。

```sql
DBMS_WORKLOAD_REPOSITORY.DROP_SNAPSHOT_RANGE(
    low_snap_id    INT,
    high_snap_id   INT
    );
```

| 字段 | 说明 |
|------|-----|
| low_snap_id | 要删除的快照的低快照 ID |
| high_snap_id | 删除的快照的高快照 ID |

#### 修改 WR 配置

在 SYS 租户下修改 WR 配置。

```sql
DBMS_WORKLOAD_REPOSITORY.MODIFY_SNAPSHOT_SETTINGS(
   retention          INT    DEFAULT  NULL,
   interval           INT    DEFAULT  NULL
   );
```

| 字段 | 说明 |
|------|-----|
| retention | 一个快照的保留时间，超过这个时间的快照将会被自动删除，单位为分钟。取值范围为 [1440 分钟（1 天），52560000 分钟（100 年）]。<ul><li>如果指定值为 0，则表示永久保留，值会成为 57816000 分钟（110 年）  </li><li>如果指定值为 NULL，则保留旧的保留值 </li></ul>|
| interval | 每个快照之间的间隔设置，单位为分钟。取值范围为 [10 分钟， 525600 分钟（1 年）]。<ul><li>如果指定值为 0，则表示将禁用自动和手动快照。会使用一个较大的系统定义值（110 年）作为保持设置</li><li>如果指定值为 NULL，则保留当前值</li></ul>|

## 使用说明

1. 升级过程中 WR 会自动关闭。
2. 可以使用 SQL 语句检查 WR 存储占用情况，如果 WR 占用存储太多可以使用 DBMS 包对数据进行删除:

   * 查看 WR 的 SSTable 占用大小：

      ```sql
      select sum(b.data_size) from __all_virtual_table a inner join __all_virtual_tablet_meta_table b on a.tenant_id=b.tenant_id and a.tablet_id=b.tablet_id left join __all_virtual_ls_meta_table c on b.tenant_id=c.tenant_id and b.ls_id = c.ls_id and b.svr_ip=c.svr_ip and b.svr_port = c.svr_port where a.table_name like "__wr_%" and a.tablet_id != 0;
      ```

   * 查看 WR 的 MemTable 占用大小：

      ```sql
      select sum(mem_used), sum(hash_mem_used), sum(btree_mem_used) from __all_virtual_table a inner join __all_virtual_memstore_info b on a.tenant_id=b.tenant_id and a.tablet_id=b.tablet_id left join __all_virtual_ls_meta_table c on b.tenant_id=c.tenant_id and b.ls_id = c.ls_id and b.svr_ip=c.svr_ip and b.svr_port = c.svr_port where a.table_name like "__wr%" and a.tablet_id != 0;
      ```
